![Alt text](./images/BannerLogo.jpg?raw=true "Title")
# pscmsForecasting
Το pscmsForecasting είναι ένα web service για την πρόβλεψη ζήτησης (demand forecasting), το οποίο υλοποιήθηκε στο πλαίσιο της Δράσης ΕΡΕΥΝΩ – ΔΗΜΙΟΥΡΓΩ - ΚΑΙΝΟΤΟΜΩ και συγχρηματοδοτήθηκε από το Ευρωπαϊκό Ταμείο Περιφερειακής Ανάπτυξης (ΕΤΠΑ) της Ευρωπαϊκής Ένωσης και εθνικούς πόρους μέσω του Ε.Π. Ανταγωνιστικότητα, Επιχειρηματικότητα & Καινοτομία (ΕΠΑνΕΚ) (κωδικός έργου: Τ2ΕΔΚ-01197: PredictionSCMS "Σύστημα Διαχειρισης Πρόβλεψης Ζήτησης και Σχεδιασμού Εφοδιαστικής Αλυσίδας").

Το pscmsForecasting επιτρέπει τη δημιουργία προβλέψεων ζήτησης χρησιμοποιώντας σύγχρονα μοντέλα μηχανικής μάθησης και πρόβλεψης χρονοσειρών. Τα μοντέλα που υλοποιεί, περιλαμβάνουν μοντέλα εκθετικής εξομάλυνσης (Exponential Smoothing), ARIMA, Prophet, Νευρωνικά Δίκτυα και μεθόδους δένδρων. Εκτός από τις προβλέψεις ζήτησης, το pscmsForecasting επιστρέφει και την τυπική απόκλιση των προβλέψεων (standard deviation), οι οποίες χρήσιμεύουν στην ποσοτικοποίηση της αβεβαιότητας (uncertainty quantification), των προβλέψεων. Επιστρέφει επίσης κάποιες βασικές μετρικές (metrics) της απόδοσης των μοντέλων στο εκάστοτε σετ δεδομένων ώστε να μπορεί να συγκριθεί η απόδοση του καθενός από αυτά, και να βελτιστοποιηθούν οι τιμές των παραμέτρων τους. 

Η υλοποίηση του πακέτου έχει βασιστεί στη γλώσσα Python, και λειτουργεί ως ένας δικτυακός εξυπηρετητής (web server), ο οποίος δέχεται μία κλήση `POST` με τα δεδομένα εκπαίδευσης και τις παραμέτρους του μοντέλου, και επιστρέφει τις προβλέψεις, το σφάλμα και τις μετρικές, όλα σε μορφή JSON. Μπορεί έτσι να χρησιμοποιηθεί ως microservice και να ενταχθεί σε μία ευρύτερη αρχιτεκτονική ενός προγράμματος πρόβλεψης ζήτησης, ή και άλλων εφαρμογών οι οποίες απαιτούν μεθόδους πρόβλεψης χρονοσειρών. 

## Περιγραφή διεπαφής (API)
Έχοντας εγκαταστήσει το pscmsForecasting επιτυχώς και εκκινήσει τον εξυπηρετητή δικτύου στη διεύθυνση π.χ. `http://localhost:5000`, οι κλήσεις στον εξυπηρετητή μπορούν να γίνουν με μία κλήση `POST` της μορφής
```bash
curl -X 'POST' \
  'http://localhost:5000' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "train_data": [<comma separated training data>],
    "pred_steps": <int>,
    "model": "<model_name>",
    "parameters": {
      "<parameter_name_1": "<parameter_value_1>",
      "<parameter_name_2": "<parameter_value_2>",
      ...
      "<parameter_name_n": "<parameter_value_n>"
    }
}'
```
Οι παράμετροι της παραπάνω κλήσης έχουν ως εξής:
* `train_data`: τα δεδομένα εκπαίδευσης χωρισμένα με κόμματα, π.χ. `[1.2, 3.4, 5, 8.9, ... 3.7]`. Κάθε ένα σημείο στην προηγούμενη λίστα αφορά την τιμή που λαμβάνει η ζητούμενη ποσότητα (π.χ. ζήτηση) σε μία χρονική περίοδο (π.χ. ένα μήνα).
* `pred_steps`: ο αριθμός των χρονικών περιόδων για τις οποίες θέλουμε να δημιουργήσουμε προβλέψεις, π.χ. αν θέλουμε προβλέψεις για 5 μήνες μετά το τέλος των δεδομένων εκπαίδευσης, θέτουμε `pred_steps: 5`.
* `model`: το όνομα του μοντέλου που θα χρησιμοποιηθεί για τις προβλέψεις. Το πακέτο υποστηρίζει τα εξής μοντέλα:
  * `ES`: Exponential Smoothing
  * `AutoETS`: AutoETS
  * `AutoArima`: AutoArima
  * `Prophet`: Prophet
  * `NN`: Νευρωνικά Δίκτυα
  * `Boost`: Μέθοδος Δένδρων
* `parameters`: πρόκειται για ένα JSON object, με κλειδιά τα ονόματα των παραμέτρων που υποστηρίζει το κάθε μοντέλο και τις αντίστοιχες τιμές του. Παραδείγματα των παραμέτρων αυτών θα δοθούν στις επόμενες παραγράφους για κάθε μοντέλο ξεχωριστά.

Εάν η κλήση είναι επιτυχής, το pscmsForecasting επιστρέφει και πάλι ένα JSON object το οποίο έχει τη μορφή
```json
{
  "fitted": [1.1, 2.2, ... 9.9],
  "forecast": [ 10.1, 11.2, ... 14.4],
  "forecast_error": [ 0.1, 0.2, 0.3 ... 0.5],
  "metrics": {
    "mae": 1.4,
    "mase": 0.8,
    "rmse": 1.7
  }
}
```
Τα παραπάνω πεδία έχουν ως εξής:
* Το πεδίο `fitted` περιλαμβάνει την προσαρμογή του μοντέλου (model fit) στα δεδομένα εκπαίδευσης, δίνοντας μια εικόνα του πόσο καλά έχει μπορέσει να τα ερμηνεύσει.
* Το πεδίο `forecast` περιλαμβάνει τις προβλέψεις του μοντέλου για τόσες μελλοντικές τιμές όσες έχουν οριστεί στην παράμετρο `pred_steps` της κλήσης του μοντέλου.
* Το πεδίο `forecast_error` περιλαμβάνει την τυπική απόκλιση των προβλέψεων (standard deviation) και πάλι για τόσες μελλοντικές τιμές όσες έχουν οριστεί στην παράμετρο `pred_steps` της κλήσης του μοντέλου.
* Το πεδίο `metrics` περιλαμβάνει κάποιες βασικές μετρικές για την απόδοση του μοντέλου στα δεδομένα εκπαίδευσης. Αυτές είναι οι 
  * `mae`: mean absolute error (μέσο απόλυτο σφάλμα)
  * `mase`: mean absolute scaled error (μέσο απόλυτο κανονικοποιημένο σφάλμα)
  * `rmse`: root mean squared error (ρίζα του μέσου τετραγωνικού σφάλματος)

Σε περίπτωση αποτυχίας δημιουργίας πρόβλεψης, το πακέτο επιστρέφει την ακόλουθη απάντηση με http code 200:
```json
{
  "error": "<error_message>"
}
```
δηλαδή ένα JSON object με κλειδί τη λέξη `error` και τιμή το μήνυμα του σφάλματος. Σφάλματα μπορεί να προκληθούν είτε από λάθος παραμέτρους ή τιμές παραμέτρων, από αδυναμία σύγκλισης των αλγορίθμων πρόβλεψης, από λανθασμένη δομή δεδομένων κ.α. Έχει καταβληθεί προσπάθεια ώστε τα μηνύματα λάθους να είναι όσο το δυνατόν ενημερωτικά σε σχέση με την πηγή του σφάλματος.

## Περιγραφή μοντέλων
### Εκθετική Εξομάλυνση
Το μοντέλο Εκθετικής Εξομάλυνσης, υλοποιεί τον αλγόριθμο `ExponentialSmoothing` που προσφέρεται από το πακέτο `statsmodels` της Python. Ο συγκεκριμένος αλγόριθμος είναι αρκετά ευέλικτος και γρήγορος, και η υλοποίησή του στο pscmsForecasting προσφέρει αρκετές δυνατότητες παραμετροποίησης. Μία τυπική κλήση για το μοντέλο αυτό έχει ως εξής:
```bash
curl -X 'POST' \
  'http://localhost:5000' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "train_data": [1.1, 2.2, ... 9.9],
    "pred_steps": 5,
    "model": "ES",
    "parameters": {
      "trend": "add",
      "damped_trend": "true",
      "seasonal": "add",
      "seasonal_periods": "12",
      "use_boxcox": "true"
    }
}'
```
Οι παράμετροι του μοντέλου αυτού έχουν ως εξής:
* `trend`: η περίληψη ή όχι κλίσης στο μοντέλο. Δυνατές τιμές των παραμέτρων είναι οι
  * `'add'`: για αθροιστική (additive) κλίση
  * `'mul'`: για πολλαπλασιαστική (multiplicative) κλίση
  * `'none`: για καθόλου κλίση
* `damped_trend`: η απόσβεση της κλίσης, με δυνατές τιμές `['true', 'false']`
* `seasonal`: η περίληψη ή όχι της εποχικότητας, με δυνατές τιμές:
  * `'add'`: για αθροιστική (additive) εποχικότητα
  * `'mul'`: για πολλαπλασιαστική (multiplicative) εποχικότητα
  * `'none'`: για καθόλου εποχικότητα
* `seasonal_periods`: Οι περίοδοι της εποχικότητας με δυνατές τιμές `['2', '3', '4', '6', '12']`
* `use_boxcox`: Η χρήση του μετασχηματισμού Box-Cox, με δυνατές τιμές
  * `'true'`: χρήση μετασχηματισμού
  * `'false'`: μη χρήση μετασχηματισμού
  * `'log'`: λογαριθμικός μετασχηματισμός


### AutoETS
Πρόκειται για ακόμη ένα αλγόριθμο Εκθετικής Εξομάλυνσης, ο οποίος υλοποιείται από το πακέτο `sktime`, ο οποίος σε σχέση με τον προηγούμενο αλγόριθμο εκθετικής εξομάλυνσης, μπορεί να υπολογίζει αυτόματα τις παραμέτρους από τα δεδομένα. Η κλήση του κατά συνέπεια είναι απλούστερη, αφού η μόνη παράμετρος που χρειάζεται να καθορίσει ο χρήστης είναι η ύπαρξη ή όχι της εποχικότητας. Ένα παράδειγμα κλήσης είναι το ακόλουθο:
```bash
curl -X 'POST' \
  'http://localhost:5000' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "train_data": [1.1, 2.2, ... 9.9],
    "pred_steps": 5,
    "model": "AutoETS",
    "parameters": {
      "seasonality": "true"
    }
}'
```
Η μοναδική παράμετρος του μοντέλου είναι η `seasonality` που μπορεί να πάρει τις τιμές `['true', 'false']`, ανάλογα με το αν ο χρήστης εκτιμά ότι τα δεδομένα του παρουσιάζουν ή όχι εποχικότητα.

### AutoARIMA
Ο συγκεκριμένος αλγόριθμος είναι παρόμοιος με τον `AutoETS`, αφού υλοποιείται και πάλι από το πακέτο `sktime` της Python, με τη διαφορά ότι πρόκειται για μοντέλο ARIMA, αντί για μοντέλο Εκθετικής Εξομάλυνσης. Όπως και στην περίπτωση αυτή, το μοντέλο επιλέγει μόνο του τη βέλτιστη παραμετροποίησή του, στηριζόμενο στα δεδομένα εκπαίδευσης, και ο χρήστη καλείται μόνο να επιλέξει την παράμετρο `seasonality`, η οποία είναι ίδια όπως και στην περίπτωση του `AutoETS`. Ακολουθεί ένα παράδειγμα κλήσης.
```bash
curl -X 'POST' \
  'http://localhost:5000' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "train_data": [1.1, 2.2, ... 9.9],
    "pred_steps": 5,
    "model": "AutoArima",
    "parameters": {
      "seasonality": "true"
    }
}'
```
### Prophet
Ο συγκεκριμένος αλγόριθμος έχει υλοποιηθεί από την εταιρεία Facebook/Meta, και πρόκειται για έναν ευέλικτο αλγόριθμο πρόβλεψης χρονοσειρών. Όπως και οι δύο προηγούμενοι αλγόριθμοι έχει και αυτός την ικανότητα να επιλέγει την κατάλληλη παραμετροποίηση με βάση τα δεδομένα εκπαίδευσης, και η μόνη παραμετροποίηση που απαιτείται από το χρήστη είναι η ύπαρξη ή όχι εποχικότητας. Ένα παράδειγμα κλήσης είναι το ακόλουθο.
```bash
curl -X 'POST' \
  'http://localhost:5000' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "train_data": [1.1, 2.2, ... 9.9],
    "pred_steps": 5,
    "model": "Prophet",
    "parameters": {
      "seasonality": "multiplicative"
    }
}'
```
Στην προκειμένη περίπτωση, ο χρήστης μπορεί να επιλέξει ανάμεσα σε αθροιστική, πολλαπλασιαστική ή καθόλου εποχικότητα, η οποία επιλέγεται με τις τιμές `['additive', 'multiplicative', 'none']` της παραμέτρου `seasonality`.

### Νευρωνικά Δίκτυα
Το πακέτο pscmsForecasting προσφέρει μεθόδους πρόβλεψης στηριζόμενες στα Επαναλαμβανόμενα Νευρωνικά Δίκτυα (Recurrent Neural Networks, RNN), όπως υλοποιούνται από το πακέτο `PyTorch` της Python. Ένα παράδειγμα κλήσης είναι το ακόλουθο:
```bash
curl -X 'POST' \
  'http://localhost:5000' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "train_data": [1.1, 2.2, ... 9.9],
    "pred_steps": 5,
    "model": "NN",
    "parameters": {
      "rnn_type": "lstm",
      "epochs": "50",
      "hidden_size": "4",
      "learning_rate": "0.05",
      "sequence_length": "4",
      "optimiser": "Adam"
    }
}'
```
Οι παράμετροι της κλήσης έχουν ως εξής:
* `rnn_type`: Ο τύπος του νευρωνικού δικτύου. Υποστηριζόμενες παράμετροι είναι οι `['lstm', 'rnn', 'gru']`.
* `epochs`: Οι εποχές εκπαίδευσης. Μεγαλύτερος αριθμός εποχών οδηγεί σε καλύτερη προσαρμογή του μοντέλου στα δεδομένα εκπαίδευσης, αυξάνει όμως τον κίνδυνο του λεγόμενου 'overfitting'. Ο χρόνος εκπαίδευσης αυξάνει επίσης με τον αριθμό των εποχών. Επιτρεπτές τιμές για τη συγκεκριμένη παράμετρο είναι `['50', '100', '500', '1000', '2000']`.
* `hidden_size`: Ο αριθμός κρυφών επιπέδων του μοντέλου. Μεγαλύτερος αριθμός κρυφών επιπέδων αυξάνει την προσαρμοστικότητα του μοντέλου στα δεδομένα εκπαίδευσης, αυξάνοντας παράλληλα το χρόνο εκπαιδευσης και τον κίνδυνο overfitting. Επιτρεπτές τιμές είναι οι `['2', '4', '8', '12', '16', '24', '32', '64']`.
* `learning_rate`: Ο ρυθμός εκμάθησης του μοντέλου. Μικρός ρυθμός εκμάθησης απαιτεί πολλές εποχές για τη σύγκλιση του μοντέλου, άρα και μεγαλύτερο χρόνο εκπαίδευσης. Μέγάλος ρυθμός, μπορεί να συντομεύσει το χρόνο εκπαίδευσης αλλά αυξάνει και την πιθανότητα αποτυχίας σύγκλισης του μοντέλου. Επιτρεπτές τιμές είναι οι `['0.001', '0.005', '0.01', '0.05', '0.1']`. 
* `sequence_length`: Ο αριθμός των παρελθοντικών τιμών που χρησιμοποιούνται στη διαδικασία εκπαίδευσης. Αν υπάρχει εποχικότητα `n` σημείων στα δεδομένα εκπαίδευσης, ο αριθμός αυτός θα πρέπει να είναι μεγαλύτερος ή ίσος του `n`. Επιτρεπτές τιμές είναι οι `['2', '4', '8', '12', '16', '24', '32', '64']`.
* `optimiser`: Ο χρησιμοποιούμενος αλγόριθμος βελτιστοποίησης. Επιτρεπτές τιμές είναι οι `['Adam', 'SGD']`.

### Μέθοδοι Δένδρων
Το pscmsForecasing προσφέρει τέλος έναν αλγόριθμο πρόβλεψης στηριζόμενος στη βιβλιοθήκη `lightgbm` της Python. Στηρίζεται στη μέθοδο δένδρων και συγκεκριμένα στη μεθοδολογία Boost. Ένα παράδειγμα κλήσης είναι το ακόλουθο:
```bash
curl -X 'POST' \
  'http://localhost:5000' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "train_data": [1.1, 2.2, ... 9.9],
    "pred_steps": 5,
    "model": "Boost",
    "parameters": {
      "sequence_length": "2",
      "num_leaves": "2",
      "max_depth": "2",
      "learning_rate": "0.01",
      "num_boost_round": "8",
      "early_stopping_rounds": "128"
    }
}'
```
Οι παράμετροι του μοντέλου αυτού έχουν ως εξής:
* `sequence_length`: Ο αριθμός των παρελθοντικών τιμών που χρησιμοποιούνται στη διαδικασία εκπαίδευσης. Αν υπάρχει εποχικότητα `n` σημείων στα δεδομένα εκπαίδευσης, ο αριθμός αυτός θα πρέπει να είναι μεγαλύτερος ή ίσος του `n`. Επιτρεπτές τιμές είναι οι `['2', '4', '8', '12', '16', '24', '32', '64']`.
* `num_leaves`: Ο αριθμός των φύλλων ανά κόμβο του δένδρου. Μεγαλύτερες τιμές της παραμέτρου κάνουν το μοντέλο πιο ευέλικτο, αυξάνοντας το χρόνο εκπαίδευσης, και τον κίνδυνο overfitting. Επιτρεπτές τιμές είναι οι `['2', '4', '8', '12', '16', '24', '32', '64']`.
* `max_depth`: Το βάθος των κόμβων του δένδρου. Μεγαλύτερες τιμές της πάραμέτρου κάνουν το μοντέλο πιο ευέλικτο, αυξάνοντας το χρόνο εκπαίδευσης, και τον κίνδυνο overfitting. To Επιτρεπτές τιμές είναι οι `['2', '4', '8', '12', '16', '24', '32', '64']`.
* `learning_rate`: Ο ρυθμός εκμάθησης του μοντέλου. Μικρός ρυθμός εκμάθησης απαιτεί πολλές εποχές για τη σύγκλιση του μοντέλου, άρα και μεγαλύτερο χρόνο εκπαίδευσης. Μεγάλος ρυθμός, μπορεί να συντομεύσει το χρόνο εκπαίδευσης αλλά αυξάνει και την πιθανότητα αποτυχίας σύγκλισης του μοντέλου. Επιτρεπτές τιμές είναι οι `['0.001', '0.005', '0.01', '0.05', '0.1']`. 
* `num_boost_round`: Αριθμός επαναλήψεων της μεθοδολογίας Boost. Μεγαλύτερες τιμές της παραμέτρου κάνουν το μοντέλο πιο ευέλικτο, αυξάνοντας το χρόνο εκπαίδευσης, και τον κίνδυνο overfitting. Επιτρεπτές τιμές είναι οι `['2', '4', '8', '16', '32', '64', '128', '256']`.
* `early_stopping_rounds`: Αριθμός επαναλήψεων κατά τις οποίες δε σημειώνεται πρόοδος, μετά τον οποίο σταματάει η εκπαιδευτική διαδικασία. Η τιμή `0`, σημαίνει ότι η διαδικασία θα σταματήσει μετά από `num_boost_round` επαναλήψεις. Επιτρεπτές τιμές είναι οι `['0', '2', '4', '8', '16', '32', '64', '128']`. 


## Οδηγίες εγκατάστασης
Για την εγκατάσταση του pscmsForecasting απαιτείται η εγκατάσταση της γλώσσας Python σε έκδοση 3.8 ή μεταγενέστερη. Η εγκατάσταση μπορεί να γίνει από την γραμμή εντολών στον κεντρικό φάκελο του pscmsForecasting ως εξής:
```bash
# Δημιουργία εικονικού περιβάλλοντος Python (virtual environment)
python -m venv venv
# Ενεργοποίηση περιβάλλοντος
. ./venv/Scripts/activate
# Ενημέρωση πακέτου εγκαταστάσεων
python -m pip install --upgrade pip
# Εγκατάσταση απαιτούμενων βιβλιοθηκών
python -m pip install -r requirements.txt
```

Με την επιτυχή εγκατάσταση των ανωτέρω, ο εξυπηρετητής μπορεί να ξεκινήσει είτε σε λειτουργία ανάπτυξης, είτε σε παραγωγική λειτουργία. 

Για την εκκίνηση σε λειτουργία ανάπτυξης εκτελείται το παρακάτω script
```bash
./run-dev
```
Ο εξυπηρετητής θα είναι στη συνέχεια διαθέσιμος στη διεύθυνση `http://localhost:5000`.

Για την εκκίνηση σε παραγωγική λειτουργία από την πόρτα π.χ. 5001 εκτελούνται τα ακόλουθα
```bash
export PORT=5001
./run-prod
```
Ο εξυπηρετητής θα είναι στη συνέχεια διαθέσιμος στη διεύθυνση `http://localhost:5001`.

## Swagger
Το pscmsPredictions διαθέτει και τη διεπαφή `Swagger` για την ευκολότερη δοκιμή του από το browser. Αυτή είναι διαθέσιμη στη διεύθυνση `http://localhost:5000/doc`.